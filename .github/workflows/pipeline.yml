name: ğŸš€ PetPal Ultimate Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'
  RAILWAY_SERVICE_NAME: "petpal-backend"
  QA_URL: "https://petpal-backend-qa.up.railway.app" 

jobs:
  # ==================================================================
  # FASE 1: CONTINUOUS INTEGRATION (CI)
  # Corre en la mÃ¡quina virtual de GitHub. No toca la nube todavÃ­a.
  # ==================================================================
  ci-tests:
    name: ğŸ—ï¸ CI: Build, Unit & Integration
    runs-on: ubuntu-latest
    timeout-minutes: 10 # ğŸ›¡ï¸ Seguridad: Si tarda mÃ¡s de 10 min, se cancela.
    steps:
      - name: ğŸ“¥ Checkout del CÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar Dependencias (Limpio)
        run: npm ci

      # 1. Tests Unitarios (LÃ³gica de Negocio con Mocks)
      - name: ğŸ§ª Ejecutar Tests Unitarios
        run: npm test

      # 2. Tests de IntegraciÃ³n (HTTP Local)
      - name: ğŸ”— Ejecutar Tests de IntegraciÃ³n Local
        run: npm run test:integration

  # ==================================================================
  # FASE 2: ESPERA DE DEPLOY (CD - QA)
  # Esperamos a que Railway detecte el commit y despliegue.
  # ==================================================================
  wait-for-qa-deploy:
    name: â³ Esperando Deploy en QA
    needs: ci-tests
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment: 
      name: qa
      url: ${{ env.QA_URL }}
    steps:
      - name: â³ Dormir 90s (Dando tiempo a Railway)
        run: sleep 90 
        # Aumentamos a 90s para asegurar que el servidor reinicie completamente.

  # ==================================================================
  # FASE 3: ACCEPTANCE TESTING (E2E)
  # Validamos el sistema vivo en la nube.
  # ==================================================================
  acceptance-tests:
    name: ğŸ•µï¸ Acceptance Tests (Live QA)
    needs: wait-for-qa-deploy
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Instalar Dependencias
        run: npm ci

      - name: ğŸ¤– Correr Tests de AceptaciÃ³n (E2E)
        run: npm run test:acceptance
        env:
          # Inyectamos la URL por si deciden usar process.env.QA_URL en el futuro
          QA_URL: ${{ env.QA_URL }} 

  # ==================================================================
  # FASE 4: AUTOMATIZACIÃ“N DE PULL REQUEST
  # Si todo pasÃ³, preparamos el pase a ProducciÃ³n.
  # ==================================================================
  create-pr:
    name: ğŸ¤– Crear PR para Main
    needs: acceptance-tests
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“© Generar Pull Request
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "ğŸš€ Release Candidate: ${{ github.sha }}"
          pr_body: |
            ## ğŸ¤– Reporte de Pipeline AutomÃ¡tico
            
            âœ… **Unit Tests:** Pasaron
            âœ… **Integration Tests:** Pasaron
            âœ… **QA Deploy:** Exitoso
            âœ… **Acceptance Tests (E2E):** Aprobados en Nube
            
            Este cÃ³digo estÃ¡ listo, validado y seguro para pasar a ProducciÃ³n.
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ==================================================================
  # FASE 5: DEPLOY A PRODUCCIÃ“N (MANUAL)
  # Solo corre en Main y requiere aprobaciÃ³n humana en GitHub Environments.
  # ==================================================================
  deploy-production:
    name: ğŸ›¡ï¸ Deploy Production
    needs: ci-tests # En main, verificamos que al menos compile y pase unitarios
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: 
      name: production
      url: https://petpal-backend-prod.up.railway.app
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ›‘ AprobaciÃ³n Manual Requerida
        run: echo "ğŸ” Despliegue aprobado manualmente por un operador."

      - name: ğŸš€ Empujar a Railway PROD
        run: npx -y @railway/cli up --service ${{ env.RAILWAY_SERVICE_NAME }} --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}