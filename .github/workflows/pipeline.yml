name: ğŸš€ PetPal Ultimate Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write
  checks: write
  statuses: write

env:
  NODE_VERSION: '20.x'
  RAILWAY_SERVICE_NAME: "petpal-backend"
  # AsegÃºrate que este sea el entorno correcto en Railway
  QA_URL: "https://dazzling-motivation-qa.up.railway.app"

jobs:
  # ------------------------------------------------------------------
  # FASE 1: CI (Build & Tests)
  # ------------------------------------------------------------------
  ci-tests:
    name: ğŸ—ï¸ CI - Tests & Build Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar Dependencias
        run: npm ci

      - name: ğŸ§ª Ejecutar Unit Tests
        run: npm test -- --reporters=default --reporters=jest-junit
        env:
          JEST_JUNIT_OUTPUT_NAME: "reports/unit-tests.xml"

      - name: ğŸ”— Ejecutar Integration Tests
        run: npm run test:integration -- --reporters=default --reporters=jest-junit
        env:
          JEST_JUNIT_OUTPUT_NAME: "reports/integration-tests.xml"

      - name: ğŸ“Š Publicar Reportes CI
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ğŸ§ª Resultados Unitarios e IntegraciÃ³n
          path: reports/*.xml
          reporter: jest-junit
          fail-on-error: false

  # ------------------------------------------------------------------
  # FASE 2: DEPLOY QA (Â¡Ahora controlado por GitHub!)
  # ------------------------------------------------------------------
  deploy-qa:
    name: ğŸš€ Deploy to QA Environment
    needs: ci-tests  # ğŸ‘ˆ ESTO ES CLAVE: Solo corre si los tests pasaron
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: 
      name: qa
      url: ${{ env.QA_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸš€ Trigger Railway Deploy (QA)
        # Reemplaza 'qa' por el nombre exacto de tu entorno en Railway si es distinto
        run: npx -y @railway/cli up --service ${{ env.RAILWAY_SERVICE_NAME }} --environment "e828deff-7916-413a-8ff9-3055a978b096" --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # Mantenemos un pequeÃ±o sleep porque --detach libera la terminal rÃ¡pido,
      # pero Railway tarda unos segundos en iniciar el nuevo contenedor.
      - name: â³ Wait for Container Cold Start
        run: sleep 60 

  # ------------------------------------------------------------------
  # FASE 3: QA VALIDATION (UAT & SMOKE TESTS)
  # ------------------------------------------------------------------
  qa-e2e-validation:
    name: ğŸ§ª QA Validation - E2E Suite
    needs: deploy-qa # ğŸ‘ˆ Ahora espera a que se mande el deploy
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Instalar
        run: npm ci

      - name: ğŸš€ Execute Acceptance Test Suite (QA)
        run: npm run test:acceptance -- --reporters=default --reporters=jest-junit
        env:
          QA_URL: ${{ env.QA_URL }}
          JEST_JUNIT_OUTPUT_NAME: "reports/acceptance-tests.xml"

      - name: ğŸ“Š Publish Quality Gate Reports
        uses: dorny/test-reporter@v1
        if: always() 
        with:
          name: ğŸ“‹ Reporte de ValidaciÃ³n QA (E2E)
          path: reports/acceptance-tests.xml
          reporter: jest-junit
          fail-on-error: false

  # ------------------------------------------------------------------
  # FASE 4: CREATE PR
  # ------------------------------------------------------------------
  create-pr:
    name: ğŸ¤– Create PR
    needs: qa-e2e-validation
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“© Generar PR
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "ğŸš€ Release Candidate: ${{ github.sha }}"
          pr_body: "âœ… Tests y Deploy en QA exitosos. Listo para Prod."
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------------
  # FASE 5: DEPLOY PROD
  # ------------------------------------------------------------------
  deploy-production:
    name: ğŸ›¡ï¸ Deploy Production
    needs: ci-tests # En Main saltamos directo a prod tras los tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://petpal-backend-production.up.railway.app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ›‘ AprobaciÃ³n Manual
        run: echo "ğŸ” Despliegue aprobado manualmente."

      - name: ğŸš€ Deploy Railway PROD
        run: npx -y @railway/cli up --service ${{ env.RAILWAY_SERVICE_NAME }} --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}