name: ğŸš€ PetPal Ultimate Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'
  RAILWAY_SERVICE_NAME: "petpal-backend"
  QA_URL: "https://petpal-backend-qa.up.railway.app"

jobs:
  # ------------------------------------------------------------------
  # FASE 1: CI (Build & Tests)
  # ------------------------------------------------------------------
  ci-tests:
    name: ğŸ—ï¸ CI - Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar
        run: npm ci

      - name: ğŸ§ª Unit Tests
        run: npm test

      - name: ğŸ”— Integration Tests
        run: npm run test:integration

  # ------------------------------------------------------------------
  # FASE 2: QA DEPLOY WAIT
  # ------------------------------------------------------------------
  wait-for-qa-deploy:
    name: â³ Wait QA Deploy
    needs: ci-tests
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: 
      name: qa
      url: ${{ env.QA_URL }}
    steps:
      - name: â³ Dormir 90s
        run: sleep 90

  # ------------------------------------------------------------------
  # FASE 3: ACCEPTANCE TESTS (E2E)
  # ------------------------------------------------------------------
  acceptance-tests:
    name: ğŸ•µï¸ E2E Acceptance
    needs: wait-for-qa-deploy
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Instalar
        run: npm ci

      - name: ğŸ¤– Run E2E Tests
        run: npm run test:acceptance
        env:
          QA_URL: ${{ env.QA_URL }}

  # ------------------------------------------------------------------
  # FASE 4: CREATE PR
  # ------------------------------------------------------------------
  create-pr:
    name: ğŸ¤– Create PR
    needs: acceptance-tests
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“© Generar PR
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "ğŸš€ Release Candidate: ${{ github.sha }}"
          pr_body: "âœ… Tests y Deploy en QA exitosos. Listo para Prod."
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------------
  # FASE 5: DEPLOY PROD
  # ------------------------------------------------------------------
  deploy-production:
    name: ğŸ›¡ï¸ Deploy Production
    needs: ci-tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://petpal-backend-prod.up.railway.app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ›‘ AprobaciÃ³n Manual
        run: echo "ğŸ” Despliegue aprobado manualmente."

      - name: ğŸš€ Deploy Railway PROD
        run: npx -y @railway/cli up --service ${{ env.RAILWAY_SERVICE_NAME }} --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}