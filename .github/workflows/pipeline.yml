name: ğŸš€ PetPal Hybrid Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'
  RAILWAY_SERVICE_NAME: "petpal-backend"

jobs:
  # 1. TESTEAR (Siempre corre)
  test-and-build:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ğŸ“¦ Instalar
        run: npm ci
      - name: ğŸ§ª Test
        run: npm test

  # 2. QA (Solo informativo en GitHub, Railway lo hace solo por detrÃ¡s)
  qa-status:
    name: âœ… QA Status
    needs: test-and-build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: 
      name: qa
      url: https://petpal-backend-qa.up.railway.app
    steps:
      - name: â„¹ï¸ Info
        run: echo "Los tests pasaron. Railway detectarÃ¡ el commit y actualizarÃ¡ QA automÃ¡ticamente."

  # 3. AUTO-PR (Tu robot secretario)
  create-pr:
    name: ğŸ¤– Auto-PR
    needs: test-and-build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸ¤– Crear PR
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "ğŸš€ Release Candidate: Pase a ProducciÃ³n"
          pr_body: "Tests OK. QA actualizÃ¡ndose. Aprueba para pasar a ProducciÃ³n."
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # 4. PROD (AquÃ­ usamos el TOKEN para forzar el deploy manual)
  deploy-production:
    name: ğŸ›¡ï¸ Deploy Production
    needs: test-and-build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://petpal-backend-prod.up.railway.app
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ›‘ AprobaciÃ³n Manual
        run: echo "ğŸ” Usuario aprobÃ³ el despliegue."

      - name: ğŸš€ Empujar a Railway PROD
        # Solo aquÃ­ usamos el token, porque le apagamos el automÃ¡tico a Prod
        run: npx -y @railway/cli up --service ${{ env.RAILWAY_SERVICE_NAME }} --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}