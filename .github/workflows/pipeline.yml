name: ğŸš€ PetPal Ultimate Pipeline

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'
  RAILWAY_SERVICE_NAME: "petpal-backend"
  # URL de QA para los tests de aceptaciÃ³n
  QA_URL: "https://petpal-backend-qa.up.railway.app" 

jobs:
  # ------------------------------------------------------------------
  # 1. UNIT TESTING (La primera barrera)
  # ------------------------------------------------------------------
  unit-tests:
    name: ğŸ§ª Unit Tests (Logic Only)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ğŸ“¦ Instalar
        run: npm ci
      - name: ğŸ”¬ Ejecutar Tests Unitarios
        run: npm test
        # Esto asume que 'npm test' corre SOLO los tests unitarios (mocks)

  # ------------------------------------------------------------------
  # 2. QA DEPLOY & E2E TESTS (Solo en rama develop)
  # ------------------------------------------------------------------
  qa-e2e-verification:
    name: ğŸ•µï¸ QA Deploy & E2E
    needs: unit-tests
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: 
      name: qa
      url: ${{ env.QA_URL }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Instalar
        run: npm ci

      # TRUCO: Como Railway despliega automÃ¡tico al detectar el commit,
      # necesitamos esperar un poco a que el servidor se reinicie con el nuevo cÃ³digo.
      - name: â³ Esperando que Railway despliegue en QA...
        run: sleep 60 
      
      - name: ğŸ¤– Run End-to-End / Acceptance Tests
        run: npm run test:integration
        # Este comando debe ejecutar los tests que le pegan a la URL real
        # Si esto falla, el pipeline se detiene y NO crea la PR.

  # ------------------------------------------------------------------
  # 3. AUTO-PR (El premio si QA pasÃ³)
  # ------------------------------------------------------------------
  create-pr:
    name: ğŸ¤– Crear Pull Request
    needs: qa-e2e-verification
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“© Generar PR a Main
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "ğŸš€ Release Candidate: ${{ github.sha }}"
          pr_body: "âœ… Tests Unitarios Pasaron.\nâœ… Deploy en QA exitoso.\nâœ… Tests E2E/AceptaciÃ³n en QA aprobados.\n\nListo para pase a ProducciÃ³n."
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------------
  # 4. DEPLOY PRODUCCIÃ“N (Solo en rama main y manual)
  # ------------------------------------------------------------------
  deploy-production:
    name: ğŸ›¡ï¸ Deploy Production
    needs: unit-tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://petpal-backend-prod.up.railway.app
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node & Railway CLI
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ›‘ Esperando AprobaciÃ³n Manual
        run: echo "ğŸ” Despliegue aprobado por un humano."

      - name: ğŸš€ Ejecutar Deploy a Railway PROD
        run: npx -y @railway/cli up --service ${{ env.RAILWAY_SERVICE_NAME }} --environment production --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}