name: PetPal Backend CI/CD Pipeline

# ConfiguraciÃ³n de Disparadores (Triggers)
# Se ejecuta en Push y PR hacia ramas crÃ­ticas, ignorando cambios en documentaciÃ³n.
on:
  push:
    branches: [ "develop", "main" ]
    paths-ignore: [ "**.md", "docs/**" ]
  pull_request:
    branches: [ "develop", "main" ]
    paths-ignore: [ "**.md", "docs/**" ]

# Variables de configuraciÃ³n global
env:
  NODE_VERSION: '20.x' # Ajustado a la versiÃ³n LTS mÃ¡s reciente o la que uses (18.x o 20.x)

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: CONTINUOUS INTEGRATION (CI)
  # ConstrucciÃ³n, instalaciÃ³n de dependencias y ejecuciÃ³n de pruebas.
  # ------------------------------------------------------------------
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Instalar Dependencias (Clean Install)
        run: npm ci

      - name: ğŸ§ª Ejecutar Suite de Pruebas (Unit & Integration)
        run: npm test
        # Si este paso falla, el pipeline se detiene automÃ¡ticamente.

  # ------------------------------------------------------------------
  # STAGE 2: CONTINUOUS DELIVERY (CD) - QA ENVIRONMENT
  # Despliegue automÃ¡tico a la rama de desarrollo.
  # ------------------------------------------------------------------
  deploy-qa:
    name: ğŸš€ Deploy to QA
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    environment: 
      name: qa 
      url: https://petpal-backend-qa.up.railway.app
    
    steps:
      - name: ğŸ“¢ NotificaciÃ³n de Despliegue
        run: |
          echo "âœ… Tests validados correctamente."
          echo "ğŸš€ Iniciando despliegue automÃ¡tico en entorno QA (Railway)..."

  # ------------------------------------------------------------------
  # STAGE 3: CONTINUOUS DEPLOYMENT (CD) - PRODUCTION ENVIRONMENT
  # Despliegue a producciÃ³n protegido por aprobaciÃ³n manual.
  # ------------------------------------------------------------------
  deploy-production:
    name: ğŸš€ Deploy to Production
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    # Gatekeeper: Requiere aprobaciÃ³n manual en GitHub Environments
    environment: 
      name: production
      url: https://petpal-backend-prod.up.railway.app
    
    steps:
      - name: ğŸ›¡ï¸ VerificaciÃ³n de Seguridad
        run: echo "ğŸ”’ AprobaciÃ³n manual verificada."

      - name: ğŸš€ ConfirmaciÃ³n de Despliegue
        run: echo "âœ… Desplegando versiÃ³n estable a ProducciÃ³n en Railway."