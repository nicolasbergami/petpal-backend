name: ğŸš€ PetPal Full Pipeline (CI/CD + Auto PR)

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "main" ]

# Permisos necesarios para que el Bot pueda crear la PR
permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'

jobs:
  # ------------------------------------------------------------------
  # TRABAJO 1: TESTEAR Y CONSTRUIR (ComÃºn a todas las ramas)
  # ------------------------------------------------------------------
  test-and-build:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Instalar Dependencias
        run: npm ci

      - name: ğŸ§ª Correr Tests (con Cobertura)
        run: npm test

  # ------------------------------------------------------------------
  # TRABAJO 2: DESPLIEGUE A QA (Solo en rama 'develop')
  # ------------------------------------------------------------------
  deploy-qa:
    name: ğŸš€ Deploy QA
    needs: test-and-build
    if: github.ref == 'refs/heads/develop' # <--- CONDICIÃ“N CLAVE
    runs-on: ubuntu-latest
    environment: 
      name: qa
      url: https://petpal-backend-qa.up.railway.app
    
    steps:
      - name: ğŸš€ Deploy simulado a QA
        run: echo "âœ… Desplegando en entorno de pruebas (Railway QA)..."

  # ------------------------------------------------------------------
  # TRABAJO 3: CREAR PULL REQUEST AUTOMÃTICA (Solo en rama 'develop')
  # ------------------------------------------------------------------
  create-pr:
    name: ğŸ¤– Auto-Create PR
    needs: test-and-build
    # Solo corre si estamos en develop Y si no es una PR
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¤– Generar Solicitud de Pase a ProducciÃ³n
        uses: repo-sync/pull-request@v2
        with:
          source_branch: "develop"
          destination_branch: "main"
          pr_title: "ğŸš€ Release Candidate: Pase a ProducciÃ³n"
          pr_body: |
            ### ğŸ¤– PR AutomÃ¡tica
            El cÃ³digo en `develop` ha pasado los tests y QA.
            
            **Para desplegar a ProducciÃ³n:**
            1. Revisa los cambios.
            2. Haz clic en **Merge Pull Request**.
            3. Ve a la pestaÃ±a **Actions** y aprueba el despliegue manual.
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------------
  # TRABAJO 4: DESPLIEGUE A PRODUCCIÃ“N (Solo en rama 'main')
  # ------------------------------------------------------------------
  deploy-production:
    name: ğŸ›¡ï¸ Deploy Production
    needs: test-and-build
    if: github.ref == 'refs/heads/main' # <--- CONDICIÃ“N CLAVE
    runs-on: ubuntu-latest
    
    # AquÃ­ estÃ¡ el CANDADO DE SEGURIDAD ğŸ”’
    environment: 
      name: production
      url: https://petpal-backend-prod.up.railway.app
    
    steps:
      - name: ğŸ›‘ VerificaciÃ³n Manual
        run: echo "ğŸ” AprobaciÃ³n de usuario verificada."

      - name: ğŸš€ Deploy a ProducciÃ³n
        run: echo "âœ… Desplegando versiÃ³n estable a ProducciÃ³n..."