// src/app.js (¬°Versi√≥n actualizada para iniciar la conexi√≥n a la DB!)
const express = require('express');
const dotenv = require('dotenv');
const connectDb = require('./config/db'); // ¬°IMPORTA LA FUNCI√ìN DE CONEXI√ìN!

const userRoutes = require('./routes/userRoutes');
const petRoutes = require('./routes/petRoutes');
const petpalRoutes = require('./routes/petpalRoutes');
const reservationRoutes = require('./routes/reservationRoutes');
const authRoutes = require('./routes/authRoutes');

dotenv.config(); // Carga las variables de entorno

const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

// ----------------------------------------------------
// ¬°CAMBIOS CR√çTICOS AQU√ç!
// ----------------------------------------------------

let dbConnection; // Variable para almacenar la conexi√≥n a la DB

// Esta funci√≥n as√≠ncrona inicia el servidor despu√©s de conectar a la DB
const startServer = async () => {
  try {
    console.log("üü° Intentando conectar a la base de datos...");
    dbConnection = await connectDb(); // Llama a la funci√≥n que retorna la promesa de conexi√≥n

    // Ahora que tenemos la conexi√≥n, la pasamos a las rutas/controladores
    // Hay varias formas de hacerlo:
    // 1. Usar app.locals (simple para apps peque√±as/medianas)
    app.locals.db = dbConnection; // La conexi√≥n estar√° disponible en req.app.locals.db en los controladores

    // 2. Pasar la conexi√≥n expl√≠citamente a cada ruta si son funciones
    // app.use('/api/users', userRoutes(dbConnection)); // Si userRoutes es una funci√≥n que acepta dbConnection

    // 3. Crear un middleware para inyectar la conexi√≥n en cada request (m√°s complejo, pero robusto)
    // app.use((req, res, next) => {
    //   req.db = dbConnection;
    //   next();
    // });

    // Rutas (ahora que la DB est√° conectada)
    console.log("üü¢ Registrando rutas en app.js...");
    app.use('/api/users', userRoutes);
    console.log("   ‚û°Ô∏è  /api/users registrado correctamente");

    app.use('/api/pets', petRoutes);
    console.log("   ‚û°Ô∏è  /api/pets registrado correctamente");

    app.use('/api/petpals', petpalRoutes);
    console.log("   ‚û°Ô∏è  /api/petpals registrado correctamente");

    app.use('/api/reservations', reservationRoutes);
    console.log("   ‚û°Ô∏è  /api/reservations registrado correctamente");

    app.use('/api/auth', authRoutes);
    console.log("   ‚û°Ô∏è  /api/auth registrado correctamente");

    // Ruta principal
    app.get('/', (req, res) => {
      res.send('Petpal API funcionando correctamente üöÄ');
    });

    // Inicia el servidor solo si la conexi√≥n a la DB fue exitosa
    app.listen(PORT, () => {
      console.log(`‚úÖ Servidor corriendo en http://localhost:${PORT}`);
    });

  } catch (error) {
    console.error('‚ùå Error fatal al iniciar la aplicaci√≥n: No se pudo conectar a la base de datos o iniciar el servidor.', error);
    process.exit(1); // Sale de la aplicaci√≥n con un c√≥digo de error
  }
};

// Llama a la funci√≥n para iniciar el servidor
startServer();

module.exports = app; // Exporta 'app' para los tests (aunque no tendr√° la DB conectada si se importa antes de startServer)

